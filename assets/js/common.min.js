var vq={};vq.common={submitForm:function(e){var t={id:"",backUrl:"",backInfo:"返回到上一页",rules:{},messages:{},successInfo:"继续添加",ignore:"",beforeSubmit:false,beforeSubmitInfo:"",success:"",fail:""};var c=$.extend({},t,e);var o=$("#"+c.id);o.validate({debug:false,onfocusout:false,onkeyup:false,highlight:false,ignore:c.ignore,onclick:false,showErrors:function(e,t){try{$(t[0].element).focus();dialog({id:"error",fixed:true,content:t[0].message,ok:function(){$(t[0].element).focus()}}).showModal()}catch(e){}},rules:c.rules,messages:c.messages,submitHandler:function(e){vq.common.block();$(e).ajaxSubmit({url:o.attr("action"),dataType:"json",success:function(e,t,o,n){vq.common.unblock();if(e.code==0){if(c.success!=""){c.success(e)}else{if(c.backUrl==""){dialog({id:"succeed",fixed:true,content:e.msg,button:[{value:c.successInfo,callback:function(){if(c.successbackUrl){location.href=c.successbackUrl}else{window.location=location.href}return true},autofocus:true},{value:"关闭"}]}).showModal()}else{dialog({id:"succeed",icon:"succeed",fixed:true,content:e.msg,button:[{value:c.successInfo,callback:function(){if(c.successbackUrl){location.href=c.successbackUrl}else{window.location=location.href}return true},autofocus:true},{value:c.backInfo,callback:function(){location.href=c.backUrl;return true}}]}).showModal()}}}else{if(c.fail!=""){c.fail(e)}else{dialog({id:"error",icon:"error",fixed:true,content:e.msg,ok:true}).showModal()}}},error:function(){vq.common.unblock();vq.common.error({content:"系统错误，请联系管理员"})}})}})},success:function(e){var t={content:"",callback:function(){}};var o=$.extend({},t,e);dialog({id:"succeed",icon:"succeed",title:"提示",fixed:true,padding:"20px 50px",content:o.content,ok:function(){o.callback()}}).showModal()},error:function(e){var t={content:"",callback:function(){}};var o=$.extend({},t,e);dialog({id:"error",title:"提示",fixed:true,padding:"20px 50px",content:o.content,ok:function(){o.callback()}}).showModal()},confirm:function(e){var t={content:"",ok:function(){},cancel:function(){}};var o=$.extend({},t,e);dialog({id:"confirm",title:"提示",fixed:true,content:"<div style='min-width: 100px;text-align: center'>"+o.content+"</div>",ok:function(){o.ok()},cancel:function(){o.cancel()}}).showModal()},getVersionsByProjectId:function(e,n,c){if(e==0){$("#"+n).empty().append('<option value="">'+c+"</option>").selectpicker("refresh");return}this.block();$.ajax({url:"/not_auth/getVersionsByProjectId",type:"get",dataType:"json",data:{project_id:e},success:function(e){vq.common.unblock();if(e.code==0){var t=e.data.projectHistories;str='<option value="">'+c+"</option>";for(var o=0;o<t.length;o++){str+='<option value="'+t[o].version+'">'+t[o].version+"</option>"}$("#"+n).empty().append(str).selectpicker("refresh")}else{vq.common.error({content:e.msg})}},error:function(){vq.common.unblock()}})},getSpidersAndServersByProjectId:function(e,a,r){if($(e).val()==""){$("#"+a).empty().append(str).selectpicker("refresh");$("#"+r).empty().append(str).selectpicker("refresh")}else{var s=this;this.block();$.ajax({url:"/not_auth/getSpidersAndServersByProjectId",type:"get",dataType:"json",data:{project:$(e).val()},success:function(e){s.unblock();if(e.code==0){var t=e.data.spiders;var o="";for(var n=0;n<t.length;n++){o+='<option value="'+t[n].id+"|"+t[n].name+'">'+t[n].name+"</option>"}$("#"+a).empty().append(o).selectpicker("refresh");o="";var c=e.data.servers;for(var n=0;n<c.length;n++){o+='<option value="'+c[n].id+"|"+c[n].host+'">'+c[n].host+"</option>"}$("#"+r).empty().append(o).selectpicker("refresh")}else{vq.common.error({content:e.msg})}},error:function(){s.unblock()}})}},block:function(){KTApp.block($("#kt_content"),{message:"请等待...",opacity:.1})},unblock:function(){KTApp.unblock($("#kt_content"))},get:function(e){var t=$(e),o=t.data("href"),n=t.data("msg"),c=t.data("datatable");if(n==""||n==undefined){n="确定要执行此操作吗？"}var a=this;dialog({title:false,content:n,follow:e,close:function(){return true},ok:function(){a.block();$.getJSON(o).done(function(e){a.unblock();if(e.code==0){if(e.url){location.href=e.url}else{if(c=="yes"){datatableObj.reload(false)}else{location.reload()}}}else{vq.common.error({content:e.msg})}})},cancel:true}).show()},updateSchedulesStatus:function(e,t){this.block();var o=this;$.ajax({url:"/task/task/updateSchedulesStatus",type:"post",dataType:"json",data:{id:e,status:t},success:function(e){o.unblock();if(e.code==0){reloadDatatable()}else{vq.common.error({content:e.msg})}},error:function(){o.unblock()}})},stopSelectedTask:function(){var n=this;vq.common.confirm({content:"确定要停止吗?",ok:function(){var e=datatableObj.getSelectedRecords();var t=[];for(var o=0;o<e.length;o++){t.push($(e[o]).find("input[type='checkbox']").val())}if(t.length>0){n.block();$.ajax({url:"/task/task/cancelMulti",type:"post",dataType:"json",data:{ids:JSON.stringify(t)},success:function(e){n.unblock();if(e.code==0){reloadDatatable(false)}else{vq.common.error({content:e.msg})}},error:function(){n.unblock()}})}else{vq.common.error({content:"请选择任务"})}}})},stopAllTask:function(){var c=this;vq.common.confirm({content:"确定要停止吗?",ok:function(){c.block();var e=$("#project_id").val();var t=$("#version").val();var o=$("#server_id").val();var n=$("#task-status .active").attr("data-status");$.ajax({url:"/task/task/cancelAll",type:"post",dataType:"json",data:{project_id:e,version:t,server_id:o,status:n},success:function(e){c.unblock();if(e.code==0){reloadDatatable(false)}else{vq.common.error({content:e.msg})}},error:function(){c.unblock()}})}})},delSelectedTask:function(){var n=this;vq.common.confirm({content:"确定要删除吗?",ok:function(){var e=datatableObj.getSelectedRecords();var t=[];for(var o=0;o<e.length;o++){t.push($(e[o]).find("input[type='checkbox']").val())}if(t.length>0){n.block();$.ajax({url:"/task/task/delMulti",type:"post",dataType:"json",data:{ids:JSON.stringify(t)},success:function(e){n.unblock();if(e.code==0){reloadDatatable(false)}else{vq.common.error({content:e.msg})}},error:function(){n.unblock()}})}else{vq.common.error({content:"请选择任务"})}}})},delAllTask:function(){var c=this;vq.common.confirm({content:"确定要删除吗?",ok:function(){c.block();var e=$("#project_id").val();var t=$("#version").val();var o=$("#server_id").val();var n=$("#task-status .active").attr("data-status");$.ajax({url:"/task/task/delAll",type:"post",dataType:"json",data:{project_id:e,version:t,server_id:o,status:n},success:function(e){c.unblock();if(e.code==0){reloadDatatable(false)}else{vq.common.error({content:e.msg})}},error:function(){c.unblock()}})}})}};